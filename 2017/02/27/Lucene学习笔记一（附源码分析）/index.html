<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>Lucene 学习笔记一（附源码分析） | 茅屋为秋风所破歌</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="lucene,full-text search" />
    
    <meta name="description" content="背景介绍
Apache Lucene is a high-performance, full-featured text search engine library written entirely in Java. It is a technology suitable for nearly any application that requires full-text search, esp">
<meta property="og:type" content="article">
<meta property="og:title" content="Lucene 学习笔记一（附源码分析）">
<meta property="og:url" content="https://leonlibraries.github.io/2017/02/27/Lucene学习笔记一（附源码分析）/index.html">
<meta property="og:site_name" content="茅屋为秋风所破歌">
<meta property="og:description" content="背景介绍
Apache Lucene is a high-performance, full-featured text search engine library written entirely in Java. It is a technology suitable for nearly any application that requires full-text search, esp">
<meta property="og:image" content="https://leonlibraries.github.io/2017/02/27/Lucene学习笔记一（附源码分析）/full-text-searching.jpg">
<meta property="og:updated_time" content="2017-02-08T03:49:14.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lucene 学习笔记一（附源码分析）">
<meta name="twitter:description" content="背景介绍
Apache Lucene is a high-performance, full-featured text search engine library written entirely in Java. It is a technology suitable for nearly any application that requires full-text search, esp">
<meta name="twitter:image" content="https://leonlibraries.github.io/2017/02/27/Lucene学习笔记一（附源码分析）/full-text-searching.jpg">
    

    
        <link rel="alternate" href="/" title="茅屋为秋风所破歌" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">技术心得分享</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/APM/">APM</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/代码设计/">代码设计</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/全文搜索/">全文搜索</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端那些事儿/">前端那些事儿</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/大数据/">大数据</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/当我们在谈论多线程的时候，我们在谈论什么/">当我们在谈论多线程的时候，我们在谈论什么</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/全文搜索/">全文搜索</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-Lucene学习笔记一（附源码分析）" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        Lucene 学习笔记一（附源码分析）
        </h1>
    

            </header>
        
        
            <div class="article-subtitle">
                <a href="/2017/02/27/Lucene学习笔记一（附源码分析）/" class="article-date">
    <time datetime="2017-02-27T02:27:15.000Z" itemprop="datePublished">2017-02-27</time>
</a>
                
    <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/full-text-search/">full-text search</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lucene/">lucene</a></li></ul>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <p><img src="/2017/02/27/Lucene学习笔记一（附源码分析）/full-text-searching.jpg" alt="全文搜索"></p>
<h1 id="背景介绍"><a href="#背景介绍" class="headerlink" title="背景介绍"></a>背景介绍</h1><blockquote>
<p>Apache Lucene is a high-performance, full-featured text search engine library written entirely in Java. It is a technology suitable for nearly any application that requires full-text search, especially cross-platform.</p>
</blockquote>
<p>有几个关键点，全文搜索库（Library）、由 Java 编写以及跨平台。本文基于 Apache Lucene 6.4.1 版本来进行讨论。</p>
<h1 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h1><h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a><strong>Document</strong></h3><p>文档，由一系列的字段（field）组成，本质上就是 field(name-&gt;value) 的集合。无论是 PDF、WORD 还是 TXT 等数据源都需要实现<code>DocumentHandler</code>接口最终生成<code>Document.class</code>类的实例，而这个实例就是这里说的文档。</p>
<h3 id="Inverted-Index"><a href="#Inverted-Index" class="headerlink" title="Inverted Index"></a><strong>Inverted Index</strong></h3><p>倒排索引，由一系列的『词—&gt;document-ids』组成，如果 field 标记为不存储，那么在获取结果的过程中，是无法获取到字段信息的，而是需要通过全文搜索得到的 ID 序列，再去其他存储系统如关系型数据库中获取出来。</p>
<p><img src="/2017/02/27/Lucene学习笔记一（附源码分析）/invert-index-sample.jpg" alt="倒排索引"></p>
<h3 id="TokenStream"><a href="#TokenStream" class="headerlink" title="TokenStream"></a><strong>TokenStream</strong></h3><p>属于 analysis 的范围，用于从文档的字段中以及查询中枚举出一系列的词（token），其有两个实现类<code>Tokenizer</code>和<code>TokenFilter</code>，以下是官方对此的解释：</p>
<blockquote>
<ul>
<li>Tokenizer, a TokenStream whose input is a Reader;</li>
<li>TokenFilter, a TokenStream whose input is another TokenStream.</li>
</ul>
</blockquote>
<p>后续对此会有进一步研究。</p>
<h1 id="关键算法流程"><a href="#关键算法流程" class="headerlink" title="关键算法流程"></a>关键算法流程</h1><h3 id="文档化-gt-分析-gt-建立索引的过程"><a href="#文档化-gt-分析-gt-建立索引的过程" class="headerlink" title="文档化 -&gt; 分析 -&gt; 建立索引的过程"></a>文档化 -&gt; 分析 -&gt; 建立索引的过程</h3><p><img src="/2017/02/27/Lucene学习笔记一（附源码分析）/document-analysis-index.png" alt="索引过程"></p>
<p>Lucene 只是负责 indexing 和 searching 阶段，至于如何将普通文件转化为 Document，这个交由开发者自行实现。</p>
<h3 id="检索阶段"><a href="#检索阶段" class="headerlink" title="检索阶段"></a>检索阶段</h3><p><img src="/2017/02/27/Lucene学习笔记一（附源码分析）/searching.png" alt="检索过程"></p>
<p>The Query Parser ： 剖析用户传入的查询 String（词、句子、一段话都有可能），并将分析后的结果传入 IndexSearcher；</p>
<p>The IndexSearcher ：包含 Analyzer、IndexReader、Scorer、Result Collector ，后续会对其进行进一步挖掘。</p>
<p>PS ：searching 过程中调用的 Analyzer 和 indexing 过程中的 Analyzer 需保持一致。</p>
<h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p><img src="/2017/02/27/Lucene学习笔记一（附源码分析）/index-and-search.png" alt="整体流程图"></p>
<p>可以看出 IndexWriter 和 QueryParser 出现共用 Analyzer 的情况，不同的索引的提词方式，有不同的检索效果。</p>
<h1 id="基础演示"><a href="#基础演示" class="headerlink" title="基础演示"></a>基础演示</h1><p>索引过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Index all text files under a directory.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is a command-line application demonstrating simple Lucene indexing.</div><div class="line"> * Run it with no command-line arguments for usage information.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IndexFiles</span> </span>&#123;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">IndexFiles</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Index all text files under a directory.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> </span>&#123;</div><div class="line">        String usage = <span class="string">"java org.wlr.lucene.learning.IndexFiles"</span></div><div class="line">                + <span class="string">" [-index INDEX_PATH] [-docs DOCS_PATH] [-update]\n\n"</span></div><div class="line">                + <span class="string">"This indexes the documents in DOCS_PATH, creating a Lucene index"</span></div><div class="line">                + <span class="string">"in INDEX_PATH that can be searched with SearchFiles"</span>;</div><div class="line">        String indexPath = <span class="string">"index"</span>;</div><div class="line">        String docsPath = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> create = <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"-index"</span>.equals(args[i])) &#123;</div><div class="line">                indexPath = args[i + <span class="number">1</span>];</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-docs"</span>.equals(args[i])) &#123;</div><div class="line">                docsPath = args[i + <span class="number">1</span>];</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-update"</span>.equals(args[i])) &#123;</div><div class="line">                create = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (docsPath == <span class="keyword">null</span>) &#123;</div><div class="line">            System.err.println(<span class="string">"Usage: "</span> + usage);</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">final</span> Path docDir = Paths.get(docsPath);</div><div class="line">        <span class="keyword">if</span> (!Files.isReadable(docDir)) &#123;</div><div class="line">            System.out.println(<span class="string">"Document directory '"</span> + docDir.toAbsolutePath() + <span class="string">"' does not exist or is not readable, please check the path"</span>);</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Date start = <span class="keyword">new</span> Date();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            System.out.println(<span class="string">"Indexing to directory '"</span> + indexPath + <span class="string">"'..."</span>);</div><div class="line"></div><div class="line">            Directory dir = FSDirectory.open(Paths.get(indexPath));</div><div class="line">            Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer();</div><div class="line">            IndexWriterConfig iwc = <span class="keyword">new</span> IndexWriterConfig(analyzer);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (create) &#123;</div><div class="line">                <span class="comment">// Create a new index in the directory, removing any</span></div><div class="line">                <span class="comment">// previously indexed documents:</span></div><div class="line">                iwc.setOpenMode(IndexWriterConfig.OpenMode.CREATE);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Add new documents to an existing index:</span></div><div class="line">                iwc.setOpenMode(IndexWriterConfig.OpenMode.CREATE_OR_APPEND);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Optional: for better indexing performance, if you</span></div><div class="line">            <span class="comment">// are indexing many documents, increase the RAM</span></div><div class="line">            <span class="comment">// buffer.  But if you do this, increase the max heap</span></div><div class="line">            <span class="comment">// size to the JVM (eg add -Xmx512m or -Xmx1g):</span></div><div class="line">            <span class="comment">//</span></div><div class="line">            <span class="comment">// iwc.setRAMBufferSizeMB(256.0);</span></div><div class="line">            IndexWriter writer = <span class="keyword">new</span> IndexWriter(dir, iwc);</div><div class="line">            indexDocs(writer, docDir);</div><div class="line"></div><div class="line">            <span class="comment">// <span class="doctag">NOTE:</span> if you want to maximize search performance,</span></div><div class="line">            <span class="comment">// you can optionally call forceMerge here.  This can be</span></div><div class="line">            <span class="comment">// a terribly costly operation, so generally it's only</span></div><div class="line">            <span class="comment">// worth it when your index is relatively static (ie</span></div><div class="line">            <span class="comment">// you're done adding documents to it):</span></div><div class="line">            <span class="comment">//</span></div><div class="line">            <span class="comment">// writer.forceMerge(1);</span></div><div class="line"></div><div class="line">            writer.close();</div><div class="line"></div><div class="line">            Date end = <span class="keyword">new</span> Date();</div><div class="line">            System.out.println(end.getTime() - start.getTime() + <span class="string">" total milliseconds"</span>);</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            System.out.println(<span class="string">" caught a "</span> + e.getClass() +</div><div class="line">                    <span class="string">"\n with message: "</span> + e.getMessage());</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Indexes the given file using the given writer, or if a directory is given,</div><div class="line">     * recurses over files and directories found under the given directory.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * <span class="doctag">NOTE:</span> This method indexes one document per input file.  This is slow.  For good</div><div class="line">     * throughput, put multiple documents into your input file(s).  An example of this is</div><div class="line">     * in the benchmark module, which can create "line doc" files, one document per line,</div><div class="line">     * using the</div><div class="line">     * &lt;a href="../../../../../contrib-benchmark/org/apache/lucene/benchmark/byTask/tasks/WriteLineDocTask.html"</div><div class="line">     * &gt;WriteLineDocTask&lt;/a&gt;.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> writer Writer to the index where the given file/dir info will be stored</div><div class="line">     * <span class="doctag">@param</span> path   The file to index, or the directory to recurse into to find files to index</div><div class="line">     * <span class="doctag">@throws</span> IOException If there is a low-level I/O error</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">indexDocs</span><span class="params">(<span class="keyword">final</span> IndexWriter writer, Path path)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">if</span> (Files.isDirectory(path)) &#123;</div><div class="line">            Files.walkFileTree(path, <span class="keyword">new</span> SimpleFileVisitor&lt;Path&gt;() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> FileVisitResult <span class="title">visitFile</span><span class="params">(Path file, BasicFileAttributes attrs)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        indexDoc(writer, file, attrs.lastModifiedTime().toMillis());</div><div class="line">                    &#125; <span class="keyword">catch</span> (IOException ignore) &#123;</div><div class="line">                        <span class="comment">//ignore</span></div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">return</span> FileVisitResult.CONTINUE;</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            indexDoc(writer, path, Files.getLastModifiedTime(path).toMillis());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Indexes a single document</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">indexDoc</span><span class="params">(IndexWriter writer, Path file, <span class="keyword">long</span> lastModified)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">try</span> (InputStream stream = Files.newInputStream(file)) &#123;</div><div class="line">            <span class="comment">// make a new, empty document</span></div><div class="line">            Document doc = <span class="keyword">new</span> Document();</div><div class="line"></div><div class="line">            <span class="comment">// Add the path of the file as a field named "path".  Use a</span></div><div class="line">            <span class="comment">// field that is indexed (i.e. searchable), but don't tokenize</span></div><div class="line">            <span class="comment">// the field into separate words and don't index term frequency</span></div><div class="line">            <span class="comment">// or positional information:</span></div><div class="line">            Field pathField = <span class="keyword">new</span> StringField(<span class="string">"path"</span>, file.toString(), Field.Store.YES);</div><div class="line">            doc.add(pathField);</div><div class="line"></div><div class="line">            <span class="comment">// Add the last modified date of the file a field named "modified".</span></div><div class="line">            <span class="comment">// Use a LongPoint that is indexed (i.e. efficiently filterable with</span></div><div class="line">            <span class="comment">// PointRangeQuery).  This indexes to milli-second resolution, which</span></div><div class="line">            <span class="comment">// is often too fine.  You could instead create a number based on</span></div><div class="line">            <span class="comment">// year/month/day/hour/minutes/seconds, down the resolution you require.</span></div><div class="line">            <span class="comment">// For example the long value 2011021714 would mean</span></div><div class="line">            <span class="comment">// February 17, 2011, 2-3 PM.</span></div><div class="line">            doc.add(<span class="keyword">new</span> LongPoint(<span class="string">"modified"</span>, lastModified));</div><div class="line"></div><div class="line">            <span class="comment">// Add the contents of the file to a field named "contents".  Specify a Reader,</span></div><div class="line">            <span class="comment">// so that the text of the file is tokenized and indexed, but not stored.</span></div><div class="line">            <span class="comment">// Note that FileReader expects the file to be in UTF-8 encoding.</span></div><div class="line">            <span class="comment">// If that's not the case searching for special characters will fail.</span></div><div class="line">            doc.add(<span class="keyword">new</span> TextField(<span class="string">"contents"</span>, <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(stream, StandardCharsets.UTF_8))));</div><div class="line"></div><div class="line">            <span class="comment">// store 只管结果返回展示部分的情况，yes 可以展示出来，no 展示不出来，</span></div><div class="line">            <span class="comment">// StringField IndexOptions 为 DOCS，因此允许搜索，但不用分词器分词，</span></div><div class="line">            <span class="comment">// 当 Store 为 NO 的时候， 该字段可以匹配搜索但是展示不出来</span></div><div class="line">            Field ext = <span class="keyword">new</span> StringField(<span class="string">"ext"</span>, <span class="string">"synchronized"</span>, Field.Store.YES);</div><div class="line">            doc.add(ext);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (writer.getConfig().getOpenMode() == IndexWriterConfig.OpenMode.CREATE) &#123;</div><div class="line">                <span class="comment">// New index, so we just add the document (no old document can be there):</span></div><div class="line">                System.out.println(<span class="string">"adding "</span> + file);</div><div class="line">                writer.addDocument(doc);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">// Existing index (an old copy of this document may have been indexed) so</span></div><div class="line">                <span class="comment">// we use updateDocument instead to replace the old one matching the exact</span></div><div class="line">                <span class="comment">// path, if present:</span></div><div class="line">                System.out.println(<span class="string">"updating "</span> + file);</div><div class="line">                writer.updateDocument(<span class="keyword">new</span> Term(<span class="string">"path"</span>, file.toString()), doc);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>查询阶段<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Simple command-line based search demo.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SearchFiles</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SearchFiles</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Simple command-line based search demo.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">        String usage = <span class="string">"Usage:\tjava org.wlr.lucene.learning.SearchFiles [-index dir] [-field f] [-repeat n] [-queries file] [-query string] [-raw] [-paging hitsPerPage]\n\nSee http://lucene.apache.org/core/4_1_0/demo/ for details."</span>;</div><div class="line">        <span class="keyword">if</span> (args.length &gt; <span class="number">0</span> &amp;&amp; (<span class="string">"-h"</span>.equals(args[<span class="number">0</span>])) || <span class="string">"-help"</span>.equals(args[<span class="number">0</span>])) &#123;</div><div class="line">            System.out.println(usage);</div><div class="line">            System.exit(<span class="number">0</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        String index = <span class="string">"index"</span>;</div><div class="line">        String field = <span class="string">"contents"</span>;</div><div class="line">        String queries = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> repeat = <span class="number">0</span>;</div><div class="line">        <span class="keyword">boolean</span> raw = <span class="keyword">false</span>;</div><div class="line">        String queryString = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> hitsPerPage = <span class="number">10</span>;</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</div><div class="line">            <span class="keyword">if</span> (<span class="string">"-index"</span>.equals(args[i])) &#123;</div><div class="line">                index = args[i + <span class="number">1</span>];</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-field"</span>.equals(args[i])) &#123;</div><div class="line">                field = args[i + <span class="number">1</span>];</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-queries"</span>.equals(args[i])) &#123;</div><div class="line">                queries = args[i + <span class="number">1</span>];</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-query"</span>.equals(args[i])) &#123;</div><div class="line">                queryString = args[i + <span class="number">1</span>];</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-repeat"</span>.equals(args[i])) &#123;</div><div class="line">                repeat = Integer.parseInt(args[i + <span class="number">1</span>]);</div><div class="line">                i++;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-raw"</span>.equals(args[i])) &#123;</div><div class="line">                raw = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"-paging"</span>.equals(args[i])) &#123;</div><div class="line">                hitsPerPage = Integer.parseInt(args[i + <span class="number">1</span>]);</div><div class="line">                <span class="keyword">if</span> (hitsPerPage &lt;= <span class="number">0</span>) &#123;</div><div class="line">                    System.err.println(<span class="string">"There must be at least 1 hit per page."</span>);</div><div class="line">                    System.exit(<span class="number">1</span>);</div><div class="line">                &#125;</div><div class="line">                i++;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        IndexReader reader = DirectoryReader.open(FSDirectory.open(Paths.get(index)));</div><div class="line">        IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</div><div class="line"></div><div class="line">        <span class="comment">// 标准分词器</span></div><div class="line">        Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer();</div><div class="line"></div><div class="line">        BufferedReader in = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (queries != <span class="keyword">null</span>) &#123;</div><div class="line">            in = Files.newBufferedReader(Paths.get(queries), StandardCharsets.UTF_8);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            in = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(System.in, StandardCharsets.UTF_8));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        QueryParser parser = <span class="keyword">new</span> QueryParser(field, analyzer);</div><div class="line">        QueryParser parserExt = <span class="keyword">new</span> QueryParser(<span class="string">"ext"</span>, analyzer);</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (queries == <span class="keyword">null</span> &amp;&amp; queryString == <span class="keyword">null</span>) &#123;</div><div class="line">                System.out.println(<span class="string">"Enter query: "</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            String line = queryString != <span class="keyword">null</span> ? queryString : in.readLine();</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (line == <span class="keyword">null</span> || line.length() == -<span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            line = line.trim();</div><div class="line">            <span class="keyword">if</span> (line.length() == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Query query = parser.parse(line);</div><div class="line">            Query queryExt = parserExt.parse(line);</div><div class="line"></div><div class="line">            <span class="comment">// 多字段匹配</span></div><div class="line">            BooleanQuery booleanQuery = <span class="keyword">new</span> BooleanQuery.Builder().add(query, BooleanClause.Occur.SHOULD)</div><div class="line">                    .add(queryExt, BooleanClause.Occur.SHOULD).build();</div><div class="line"></div><div class="line">            System.out.println(<span class="string">"Searching for: "</span> + query.toString(field));</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (repeat &gt; <span class="number">0</span>) &#123;                   <span class="comment">// repeat &amp; time as benchmark</span></div><div class="line">                Date start = <span class="keyword">new</span> Date();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; repeat; i++) &#123;</div><div class="line">                    searcher.search(booleanQuery, <span class="number">100</span>);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Date end = <span class="keyword">new</span> Date();</div><div class="line">                System.out.println(<span class="string">"Time: "</span> + (end.getTime() - start.getTime()) + <span class="string">"ms"</span>);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            doPagingSearch(in, searcher, booleanQuery, hitsPerPage, raw, queries == <span class="keyword">null</span> &amp;&amp; queryString == <span class="keyword">null</span>);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (queryString != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        reader.close();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * This demonstrates a typical paging search scenario, where the search engine presents</div><div class="line">     * pages of size n to the user. The user can then go to the next page if interested in</div><div class="line">     * the next hits.</div><div class="line">     * &lt;p&gt;</div><div class="line">     * When the query is executed for the first time, then only enough results are collected</div><div class="line">     * to fill 5 result pages. If the user wants to page beyond this limit, then the query</div><div class="line">     * is executed another time and all hits are collected.</div><div class="line">     */</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doPagingSearch</span><span class="params">(BufferedReader in, IndexSearcher searcher, Query query,</span></span></div><div class="line">                                      <span class="keyword">int</span> hitsPerPage, <span class="keyword">boolean</span> raw, <span class="keyword">boolean</span> interactive) <span class="keyword">throws</span> IOException &#123;</div><div class="line">        <span class="comment">// Collect enough docs to show 5 pages</span></div><div class="line">        TopDocs results = searcher.search(query, <span class="number">5</span> * hitsPerPage);</div><div class="line">        ScoreDoc[] hits = results.scoreDocs;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> numTotalHits = results.totalHits;</div><div class="line">        System.out.println(numTotalHits + <span class="string">" total matching documents"</span>);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> end = Math.min(numTotalHits, hitsPerPage);</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (end &gt; hits.length) &#123;</div><div class="line">                System.out.println(<span class="string">"Only results 1 - "</span> + hits.length + <span class="string">" of "</span> + numTotalHits + <span class="string">" total matching documents collected."</span>);</div><div class="line">                System.out.println(<span class="string">"Collect more (y/n) ?"</span>);</div><div class="line">                String line = in.readLine();</div><div class="line">                <span class="keyword">if</span> (line.length() == <span class="number">0</span> || line.charAt(<span class="number">0</span>) == <span class="string">'n'</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                hits = searcher.search(query, numTotalHits).scoreDocs;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            end = Math.min(hits.length, start + hitsPerPage);</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = start; i &lt; end; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (raw) &#123;   <span class="comment">// output raw format</span></div><div class="line">                    System.out.println(<span class="string">"doc="</span> + hits[i].doc + <span class="string">" score="</span> + hits[i].score);</div><div class="line">                    <span class="keyword">continue</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                Document doc = searcher.doc(hits[i].doc);</div><div class="line">                String path = doc.get(<span class="string">"path"</span>);</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</div><div class="line">                    System.out.println((i + <span class="number">1</span>) + <span class="string">". "</span> + path);</div><div class="line">                    String title = doc.get(<span class="string">"title"</span>);</div><div class="line">                    <span class="keyword">if</span> (title != <span class="keyword">null</span>) &#123;</div><div class="line">                        System.out.println(<span class="string">"   Title: "</span> + doc.get(<span class="string">"title"</span>));</div><div class="line">                    &#125;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    System.out.println((i + <span class="number">1</span>) + <span class="string">". "</span> + <span class="string">"No path for this document"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!interactive || end == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (numTotalHits &gt;= end) &#123;</div><div class="line">                <span class="keyword">boolean</span> quit = <span class="keyword">false</span>;</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    System.out.print(<span class="string">"Press "</span>);</div><div class="line">                    <span class="keyword">if</span> (start - hitsPerPage &gt;= <span class="number">0</span>) &#123;</div><div class="line">                        System.out.println(<span class="string">"(p)revious page,"</span>);</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (start + hitsPerPage &lt; numTotalHits) &#123;</div><div class="line">                        System.out.print(<span class="string">"(n)ext page, "</span>);</div><div class="line">                    &#125;</div><div class="line">                    System.out.println(<span class="string">"(q)uit or enter number to jump to a page."</span>);</div><div class="line"></div><div class="line">                    String line = in.readLine();</div><div class="line">                    <span class="keyword">if</span> (line.length() == <span class="number">0</span> || line.charAt(<span class="number">0</span>) == <span class="string">'q'</span>) &#123;</div><div class="line">                        quit = <span class="keyword">true</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">if</span> (line.charAt(<span class="number">0</span>) == <span class="string">'p'</span>) &#123;</div><div class="line">                        quit = <span class="keyword">true</span>;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (line.charAt(<span class="number">0</span>) == <span class="string">'n'</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (start + hitsPerPage &lt; numTotalHits) &#123;</div><div class="line">                            start += hitsPerPage;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">int</span> page = Integer.parseInt(line);</div><div class="line">                        <span class="keyword">if</span> ((page - <span class="number">1</span>) * hitsPerPage &lt; numTotalHits) &#123;</div><div class="line">                            start = (page - <span class="number">1</span>) * hitsPerPage;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            System.out.println(<span class="string">"No such page"</span>);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (quit) <span class="keyword">break</span>;</div><div class="line">                end = Math.min(numTotalHits, start + hitsPerPage);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><h3 id="Document-1"><a href="#Document-1" class="headerlink" title="Document"></a>Document</h3><p>来看看源码，从 <code>Document</code> 看起 (这里Document类代码不完整)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/** Documents are the unit of indexing and search.</span></div><div class="line"> *</div><div class="line"> * A Document is a set of fields.  Each field has a name and a textual value.</div><div class="line"> * A field may be &#123;<span class="doctag">@link</span> org.apache.lucene.index.IndexableFieldType#stored() stored&#125; with the document, in which</div><div class="line"> * case it is returned with search hits on the document.  Thus each document</div><div class="line"> * should typically contain one or more stored fields which uniquely identify</div><div class="line"> * it.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Note that fields which are &lt;i&gt;not&lt;/i&gt; &#123;<span class="doctag">@link</span> org.apache.lucene.index.IndexableFieldType#stored() stored&#125; are</div><div class="line"> * &lt;i&gt;not&lt;/i&gt; available in documents retrieved from the index, e.g. with &#123;<span class="doctag">@link</span></div><div class="line"> * ScoreDoc#doc&#125; or &#123;<span class="doctag">@link</span> IndexReader#document(int)&#125;.</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Document</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">IndexableField</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> List&lt;IndexableField&gt; fields = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">  <span class="comment">/** Constructs a new document with no fields. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Document</span><span class="params">()</span> </span>&#123;&#125;</div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> Iterator&lt;IndexableField&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> fields.iterator();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &lt;p&gt;Adds a field to a document.  Several fields may be added with</div><div class="line">   * the same name.  In this case, if the fields are indexed, their text is</div><div class="line">   * treated as though appended for the purposes of search.&lt;/p&gt;</div><div class="line">   * &lt;p&gt; Note that add like the removeField(s) methods only makes sense</div><div class="line">   * prior to adding a document to an index. These methods cannot</div><div class="line">   * be used to change the content of an existing index! In order to achieve this,</div><div class="line">   * a document has to be deleted from an index and a new changed version of that</div><div class="line">   * document has to be added.&lt;/p&gt;</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(IndexableField field)</span> </span>&#123;</div><div class="line">    fields.add(field);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &lt;p&gt;Removes field with the specified name from the document.</div><div class="line">   * If multiple fields exist with this name, this method removes the first field that has been added.</div><div class="line">   * If there is no field with the specified name, the document remains unchanged.&lt;/p&gt;</div><div class="line">   * &lt;p&gt; Note that the removeField(s) methods like the add method only make sense</div><div class="line">   * prior to adding a document to an index. These methods cannot</div><div class="line">   * be used to change the content of an existing index! In order to achieve this,</div><div class="line">   * a document has to be deleted from an index and a new changed version of that</div><div class="line">   * document has to be added.&lt;/p&gt;</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeField</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    Iterator&lt;IndexableField&gt; it = fields.iterator();</div><div class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">      IndexableField field = it.next();</div><div class="line">      <span class="keyword">if</span> (field.name().equals(name)) &#123;</div><div class="line">        it.remove();</div><div class="line">        <span class="keyword">return</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * &lt;p&gt;Removes all fields with the given name from the document.</div><div class="line">   * If there is no field with the specified name, the document remains unchanged.&lt;/p&gt;</div><div class="line">   * &lt;p&gt; Note that the removeField(s) methods like the add method only make sense</div><div class="line">   * prior to adding a document to an index. These methods cannot</div><div class="line">   * be used to change the content of an existing index! In order to achieve this,</div><div class="line">   * a document has to be deleted from an index and a new changed version of that</div><div class="line">   * document has to be added.&lt;/p&gt;</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeFields</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    Iterator&lt;IndexableField&gt; it = fields.iterator();</div><div class="line">    <span class="keyword">while</span> (it.hasNext()) &#123;</div><div class="line">      IndexableField field = it.next();</div><div class="line">      <span class="keyword">if</span> (field.name().equals(name)) &#123;</div><div class="line">        it.remove();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a field with the given name if any exist in this document, or</span></div><div class="line">   * null.  If multiple fields exists with this name, this method returns the</div><div class="line">   * first value added.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IndexableField <span class="title">getField</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (IndexableField field : fields) &#123;</div><div class="line">      <span class="keyword">if</span> (field.name().equals(name)) &#123;</div><div class="line">        <span class="keyword">return</span> field;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Returns an array of &#123;<span class="doctag">@link</span> IndexableField&#125;s with the given name.</div><div class="line">   * This method returns an empty array when there are no</div><div class="line">   * matching fields.  It never returns null.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@param</span> name the name of the field</div><div class="line">   * <span class="doctag">@return</span> a &lt;code&gt;Field[]&lt;/code&gt; array</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> IndexableField[] getFields(String name) &#123;</div><div class="line">    List&lt;IndexableField&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (IndexableField field : fields) &#123;</div><div class="line">      <span class="keyword">if</span> (field.name().equals(name)) &#123;</div><div class="line">        result.add(field);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result.toArray(<span class="keyword">new</span> IndexableField[result.size()]);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns a List of all the fields in a document.</span></div><div class="line">   * &lt;p&gt;Note that fields which are &lt;i&gt;not&lt;/i&gt; stored are</div><div class="line">   * &lt;i&gt;not&lt;/i&gt; available in documents retrieved from the</div><div class="line">   * index, e.g. &#123;<span class="doctag">@link</span> IndexSearcher#doc(int)&#125; or &#123;<span class="doctag">@link</span></div><div class="line">   * IndexReader#document(int)&#125;.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> an immutable &lt;code&gt;List&amp;lt;Field&amp;gt;&lt;/code&gt;</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> List&lt;IndexableField&gt; <span class="title">getFields</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> Collections.unmodifiableList(fields);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String[] NO_STRINGS = <span class="keyword">new</span> String[<span class="number">0</span>];</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Returns an array of values of the field specified as the method parameter.</div><div class="line">   * This method returns an empty array when there are no</div><div class="line">   * matching fields.  It never returns null.</div><div class="line">   * For a numeric &#123;<span class="doctag">@link</span> StoredField&#125; it returns the string value of the number. If you want</div><div class="line">   * the actual numeric field instances back, use &#123;<span class="doctag">@link</span> #getFields&#125;.</div><div class="line">   * <span class="doctag">@param</span> name the name of the field</div><div class="line">   * <span class="doctag">@return</span> a &lt;code&gt;String[]&lt;/code&gt; of field values</div><div class="line">   */</div><div class="line">  <span class="keyword">public</span> <span class="keyword">final</span> String[] getValues(String name) &#123;</div><div class="line">    List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (IndexableField field : fields) &#123;</div><div class="line">      <span class="keyword">if</span> (field.name().equals(name) &amp;&amp; field.stringValue() != <span class="keyword">null</span>) &#123;</div><div class="line">        result.add(field.stringValue());</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (result.size() == <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">return</span> NO_STRINGS;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> result.toArray(<span class="keyword">new</span> String[result.size()]);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Returns the string value of the field with the given name if any exist in</span></div><div class="line">   * this document, or null.  If multiple fields exist with this name, this</div><div class="line">   * method returns the first value added. If only binary fields with this name</div><div class="line">   * exist, returns null.</div><div class="line">   * For a numeric &#123;<span class="doctag">@link</span> StoredField&#125; it returns the string value of the number. If you want</div><div class="line">   * the actual numeric field instance back, use &#123;<span class="doctag">@link</span> #getField&#125;.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">get</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (IndexableField field : fields) &#123;</div><div class="line">      <span class="keyword">if</span> (field.name().equals(name) &amp;&amp; field.stringValue() != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> field.stringValue();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Removes all the fields from document. */</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</div><div class="line">    fields.clear();</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们可以看到 <code>Document</code> 实现了 <code>Iterable&lt;IndexableField&gt;</code>接口，也就意味着 <code>Document</code> 本身是有多个 <code>IndexableField</code> 组成的。</p>
<h3 id="DefaultIndexingChain"><a href="#DefaultIndexingChain" class="headerlink" title="DefaultIndexingChain"></a>DefaultIndexingChain</h3><p>创建 <code>DocConsumer</code> 消费文档的内容<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// this should be the last call in the ctor</span></div><div class="line"><span class="comment">// it really sucks that we need to pull this within the ctor and pass this ref to the chain!</span></div><div class="line">DocConsumer consumer = indexWriterConfig.getIndexingChain().getChain(<span class="keyword">this</span>);</div></pre></td></tr></table></figure></p>
<p>其中创建的有可能是默认的索引处理链 ，<code>DocConsumer</code>  的子类<code>DefaultIndexingChain</code>，该类包含了将文档转化为索引的核心逻辑，十分重要。后续将从此类展开来讲。</p>
<p><code>DefaultIndexingChain</code>遍历文档里的每一个字段(field)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (IndexableField field : docState.doc) &#123;</div><div class="line">  fieldCount = processField(field, fieldGen, fieldCount);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接下来着重看下<code>processField</code>方法，这里包含了一个字段是否被索引、stored、以及 DocValue 存储的核心逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">processField</span><span class="params">(IndexableField field, <span class="keyword">long</span> fieldGen, <span class="keyword">int</span> fieldCount)</span> <span class="keyword">throws</span> IOException, AbortingException </span>&#123;</div><div class="line">    String fieldName = field.name();</div><div class="line">    IndexableFieldType fieldType = field.fieldType();</div><div class="line"></div><div class="line">    PerField fp = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (fieldType.indexOptions() == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"IndexOptions must not be null (field: \""</span> + field.name() + <span class="string">"\")"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Invert indexed fields:</span></div><div class="line">    <span class="keyword">if</span> (fieldType.indexOptions() != IndexOptions.NONE) &#123;</div><div class="line"></div><div class="line">      <span class="comment">// if the field omits norms, the boost cannot be indexed.</span></div><div class="line">      <span class="keyword">if</span> (fieldType.omitNorms() &amp;&amp; field.boost() != <span class="number">1.0f</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"You cannot set an index-time boost: norms are omitted for field '"</span> + field.name() + <span class="string">"'"</span>);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      fp = getOrAddField(fieldName, fieldType, <span class="keyword">true</span>);</div><div class="line">      <span class="keyword">boolean</span> first = fp.fieldGen != fieldGen;</div><div class="line">      fp.invert(field, first);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (first) &#123;</div><div class="line">        fields[fieldCount++] = fp;</div><div class="line">        fp.fieldGen = fieldGen;</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      verifyUnIndexedFieldType(fieldName, fieldType);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Add stored fields:</span></div><div class="line">    <span class="keyword">if</span> (fieldType.stored()) &#123;</div><div class="line">      <span class="keyword">if</span> (fp == <span class="keyword">null</span>) &#123;</div><div class="line">        fp = getOrAddField(fieldName, fieldType, <span class="keyword">false</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (fieldType.stored()) &#123;</div><div class="line">        String value = field.stringValue();</div><div class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; IndexWriter.MAX_STORED_STRING_LENGTH) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"stored field \""</span> + field.name() + <span class="string">"\" is too large ("</span> + value.length() + <span class="string">" characters) to store"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          storedFieldsWriter.writeField(fp.fieldInfo, field);</div><div class="line">        &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">          <span class="keyword">throw</span> AbortingException.wrap(th);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    DocValuesType dvType = fieldType.docValuesType();</div><div class="line">    <span class="keyword">if</span> (dvType == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"docValuesType must not be null (field: \""</span> + fieldName + <span class="string">"\")"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (dvType != DocValuesType.NONE) &#123;</div><div class="line">      <span class="keyword">if</span> (fp == <span class="keyword">null</span>) &#123;</div><div class="line">        fp = getOrAddField(fieldName, fieldType, <span class="keyword">false</span>);</div><div class="line">      &#125;</div><div class="line">      indexDocValue(fp, dvType, field);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (fieldType.pointDimensionCount() != <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">if</span> (fp == <span class="keyword">null</span>) &#123;</div><div class="line">        fp = getOrAddField(fieldName, fieldType, <span class="keyword">false</span>);</div><div class="line">      &#125;</div><div class="line">      indexPoint(fp, field);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> fieldCount;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>进入 <code>getOrAddField</code> 方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// fieldHash 维护了一套字段集合 ，通过名字如果能在其 Segment 中找到其对应的字段，那么就不必要重新建立新字段了</span></div><div class="line">PerField fp = fieldHash[hashPos];</div><div class="line"><span class="keyword">while</span> (fp != <span class="keyword">null</span> &amp;&amp; !fp.fieldInfo.name.equals(name)) &#123;</div><div class="line">  fp = fp.next;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 如果在所属 segment 下找不到对应的字段，那么就要考虑新建了</span></div><div class="line"><span class="keyword">if</span> (fp == <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="comment">// First time we are seeing this field in this segment</span></div><div class="line"></div><div class="line">  FieldInfo fi = fieldInfos.getOrAdd(name);</div><div class="line">  <span class="comment">// Messy: must set this here because e.g. FreqProxTermsWriterPerField looks at the initial</span></div><div class="line">  <span class="comment">// IndexOptions to decide what arrays it must create).  Then, we also must set it in</span></div><div class="line">  <span class="comment">// PerField.invert to allow for later downgrading of the index options:</span></div><div class="line">  fi.setIndexOptions(fieldType.indexOptions());</div><div class="line"></div><div class="line">  fp = <span class="keyword">new</span> PerField(fi, invert);</div><div class="line">  fp.next = fieldHash[hashPos];</div><div class="line">  fieldHash[hashPos] = fp;</div><div class="line">  totalFieldCount++;</div><div class="line"></div><div class="line">  <span class="comment">// At most 50% load factor:</span></div><div class="line">  <span class="keyword">if</span> (totalFieldCount &gt;= fieldHash.length/<span class="number">2</span>) &#123;</div><div class="line">    <span class="comment">// 字段超过占用50%则需要做 rehash 的动作，目的是扩充 fieldHash 数组大小</span></div><div class="line">    rehash();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (totalFieldCount &gt; fields.length) &#123;</div><div class="line">    <span class="comment">// 扩充 fields 数组大小，fields 数组是用来维护一个 document 里所有的字段信息的</span></div><div class="line">    PerField[] newFields = <span class="keyword">new</span> PerField[ArrayUtil.oversize(totalFieldCount, RamUsageEstimator.NUM_BYTES_OBJECT_REF)];</div><div class="line">    System.arraycopy(fields, <span class="number">0</span>, newFields, <span class="number">0</span>, fields.length);</div><div class="line">    fields = newFields;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (invert &amp;&amp; fp.invertState == <span class="keyword">null</span>) &#123;</div><div class="line">  <span class="comment">// Messy: must set this here because e.g. FreqProxTermsWriterPerField looks at the initial</span></div><div class="line">  <span class="comment">// IndexOptions to decide what arrays it must create).  Then, we also must set it in</span></div><div class="line">  <span class="comment">// PerField.invert to allow for later downgrading of the index options:</span></div><div class="line">  fp.fieldInfo.setIndexOptions(fieldType.indexOptions());</div><div class="line">  fp.setInvertState();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>关于 <code>fieldHash</code> 数组：每一个元素表示为一个 <code>Segment</code>，每个 <code>Segment</code> 中以链表的形式维护一个<code>Field</code>序列。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">fp = getOrAddField(fieldName, fieldType, <span class="keyword">true</span>);</div><div class="line"><span class="keyword">boolean</span> first = fp.fieldGen != fieldGen;</div><div class="line">fp.invert(field, first);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (first) &#123;</div><div class="line">  fields[fieldCount++] = fp;</div><div class="line">  fp.fieldGen = fieldGen;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>fieldGen</code>用来标记字段是否是第一次出现，如果是第一次出现，那么需要将字段放到 <code>fields</code>数组中维护。</p>
<h3 id="TokenStream-1"><a href="#TokenStream-1" class="headerlink" title="TokenStream"></a>TokenStream</h3><p>接下来继续看看建立倒排索引最核心的方法 <code>fp.invert(field, first);</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** Inverts one field for one document; first is true</span></div><div class="line"> *  if this is the first time we are seeing this field</div><div class="line"> *  name in this document. */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invert</span><span class="params">(IndexableField field, <span class="keyword">boolean</span> first)</span> <span class="keyword">throws</span> IOException, AbortingException </span>&#123;</div><div class="line">  <span class="keyword">if</span> (first) &#123;</div><div class="line">    <span class="comment">// First time we're seeing this field (indexed) in</span></div><div class="line">    <span class="comment">// this document:</span></div><div class="line">    invertState.reset();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  IndexableFieldType fieldType = field.fieldType();</div><div class="line"></div><div class="line">  IndexOptions indexOptions = fieldType.indexOptions();</div><div class="line">  fieldInfo.setIndexOptions(indexOptions);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (fieldType.omitNorms()) &#123;</div><div class="line">    fieldInfo.setOmitsNorms();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> analyzed = fieldType.tokenized() &amp;&amp; docState.analyzer != <span class="keyword">null</span>;</div><div class="line"></div><div class="line">  <span class="comment">// only bother checking offsets if something will consume them.</span></div><div class="line">  <span class="comment">// <span class="doctag">TODO:</span> after we fix analyzers, also check if termVectorOffsets will be indexed.</span></div><div class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> checkOffsets = indexOptions == IndexOptions.DOCS_AND_FREQS_AND_POSITIONS_AND_OFFSETS;</div><div class="line"></div><div class="line">  <span class="comment">/*</span></div><div class="line">   * To assist people in tracking down problems in analysis components, we wish to write the field name to the infostream</div><div class="line">   * when we fail. We expect some caller to eventually deal with the real exception, so we don't want any 'catch' clauses,</div><div class="line">   * but rather a finally that takes note of the problem.</div><div class="line">   */</div><div class="line">  <span class="keyword">boolean</span> succeededInProcessingField = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">try</span> (TokenStream stream = tokenStream = field.tokenStream(docState.analyzer, tokenStream)) &#123;</div><div class="line">    <span class="comment">// reset the TokenStream to the first token</span></div><div class="line">    stream.reset();</div><div class="line">    invertState.setAttributeSource(stream);</div><div class="line">    termsHashPerField.start(field, first);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (stream.incrementToken()) &#123;</div><div class="line"></div><div class="line">      <span class="comment">// If we hit an exception in stream.next below</span></div><div class="line">      <span class="comment">// (which is fairly common, e.g. if analyzer</span></div><div class="line">      <span class="comment">// chokes on a given document), then it's</span></div><div class="line">      <span class="comment">// non-aborting and (above) this one document</span></div><div class="line">      <span class="comment">// will be marked as deleted, but still</span></div><div class="line">      <span class="comment">// consume a docID</span></div><div class="line"></div><div class="line">      <span class="keyword">int</span> posIncr = invertState.posIncrAttribute.getPositionIncrement();</div><div class="line">      invertState.position += posIncr;</div><div class="line">      <span class="keyword">if</span> (invertState.position &lt; invertState.lastPosition) &#123;</div><div class="line">        <span class="keyword">if</span> (posIncr == <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"first position increment must be &gt; 0 (got 0) for field '"</span> + field.name() + <span class="string">"'"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (posIncr &lt; <span class="number">0</span>) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"position increment must be &gt;= 0 (got "</span> + posIncr + <span class="string">") for field '"</span> + field.name() + <span class="string">"'"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"position overflowed Integer.MAX_VALUE (got posIncr="</span> + posIncr + <span class="string">" lastPosition="</span> + invertState.lastPosition + <span class="string">" position="</span> + invertState.position + <span class="string">") for field '"</span> + field.name() + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (invertState.position &gt; IndexWriter.MAX_POSITION) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"position "</span> + invertState.position + <span class="string">" is too large for field '"</span> + field.name() + <span class="string">"': max allowed position is "</span> + IndexWriter.MAX_POSITION);</div><div class="line">      &#125;</div><div class="line">      invertState.lastPosition = invertState.position;</div><div class="line">      <span class="keyword">if</span> (posIncr == <span class="number">0</span>) &#123;</div><div class="line">        invertState.numOverlap++;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (checkOffsets) &#123;</div><div class="line">        <span class="keyword">int</span> startOffset = invertState.offset + invertState.offsetAttribute.startOffset();</div><div class="line">        <span class="keyword">int</span> endOffset = invertState.offset + invertState.offsetAttribute.endOffset();</div><div class="line">        <span class="keyword">if</span> (startOffset &lt; invertState.lastStartOffset || endOffset &lt; startOffset) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"startOffset must be non-negative, and endOffset must be &gt;= startOffset, and offsets must not go backwards "</span></div><div class="line">                                             + <span class="string">"startOffset="</span> + startOffset + <span class="string">",endOffset="</span> + endOffset + <span class="string">",lastStartOffset="</span> + invertState.lastStartOffset + <span class="string">" for field '"</span> + field.name() + <span class="string">"'"</span>);</div><div class="line">        &#125;</div><div class="line">        invertState.lastStartOffset = startOffset;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      invertState.length++;</div><div class="line">      <span class="keyword">if</span> (invertState.length &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"too many tokens in field '"</span> + field.name() + <span class="string">"'"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="comment">//System.out.println("  term=" + invertState.termAttribute);</span></div><div class="line"></div><div class="line">      <span class="comment">// If we hit an exception in here, we abort</span></div><div class="line">      <span class="comment">// all buffered documents since the last</span></div><div class="line">      <span class="comment">// flush, on the likelihood that the</span></div><div class="line">      <span class="comment">// internal state of the terms hash is now</span></div><div class="line">      <span class="comment">// corrupt and should not be flushed to a</span></div><div class="line">      <span class="comment">// new segment:</span></div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        termsHashPerField.add();</div><div class="line">      &#125; <span class="keyword">catch</span> (MaxBytesLengthExceededException e) &#123;</div><div class="line">        <span class="keyword">byte</span>[] prefix = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">30</span>];</div><div class="line">        BytesRef bigTerm = invertState.termAttribute.getBytesRef();</div><div class="line">        System.arraycopy(bigTerm.bytes, bigTerm.offset, prefix, <span class="number">0</span>, <span class="number">30</span>);</div><div class="line">        String msg = <span class="string">"Document contains at least one immense term in field=\""</span> + fieldInfo.name + <span class="string">"\" (whose UTF8 encoding is longer than the max length "</span> + DocumentsWriterPerThread.MAX_TERM_LENGTH_UTF8 + <span class="string">"), all of which were skipped.  Please correct the analyzer to not produce such terms.  The prefix of the first immense term is: '"</span> + Arrays.toString(prefix) + <span class="string">"...', original message: "</span> + e.getMessage();</div><div class="line">        <span class="keyword">if</span> (docState.infoStream.isEnabled(<span class="string">"IW"</span>)) &#123;</div><div class="line">          docState.infoStream.message(<span class="string">"IW"</span>, <span class="string">"ERROR: "</span> + msg);</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Document will be deleted above:</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(msg, e);</div><div class="line">      &#125; <span class="keyword">catch</span> (Throwable th) &#123;</div><div class="line">        <span class="keyword">throw</span> AbortingException.wrap(th);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// trigger streams to perform end-of-stream operations</span></div><div class="line">    stream.end();</div><div class="line"></div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> maybe add some safety? then again, it's already checked</span></div><div class="line">    <span class="comment">// when we come back around to the field...</span></div><div class="line">    invertState.position += invertState.posIncrAttribute.getPositionIncrement();</div><div class="line">    invertState.offset += invertState.offsetAttribute.endOffset();</div><div class="line"></div><div class="line">    <span class="comment">/* if there is an exception coming through, we won't set this to true here:*/</span></div><div class="line">    succeededInProcessingField = <span class="keyword">true</span>;</div><div class="line">  &#125; <span class="keyword">finally</span> &#123;</div><div class="line">    <span class="keyword">if</span> (!succeededInProcessingField &amp;&amp; docState.infoStream.isEnabled(<span class="string">"DW"</span>)) &#123;</div><div class="line">      docState.infoStream.message(<span class="string">"DW"</span>, <span class="string">"An exception was thrown while processing field "</span> + fieldInfo.name);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (analyzed) &#123;</div><div class="line">    invertState.position += docState.analyzer.getPositionIncrementGap(fieldInfo.name);</div><div class="line">    invertState.offset += docState.analyzer.getOffsetGap(fieldInfo.name);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  invertState.boost *= field.boost();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们大致可以看出，这里的逻辑无外乎根据索引选项<code>IndexOptions</code>来判断索引的颗粒度大小，进而再用<code>TokenStream</code>将字段里的内容进行分词、提词。每一个<code>Field</code>都有其对应的<code>TokenStream</code>。以下是<code>TokenStream</code>的源码参照：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * A &lt;code&gt;TokenStream&lt;/code&gt; enumerates the sequence of tokens, either from</div><div class="line"> * &#123;<span class="doctag">@link</span> Field&#125;s of a &#123;<span class="doctag">@link</span> Document&#125; or from query text.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * This is an abstract class; concrete subclasses are:</div><div class="line"> * &lt;ul&gt;</div><div class="line"> * &lt;li&gt;&#123;<span class="doctag">@link</span> Tokenizer&#125;, a &lt;code&gt;TokenStream&lt;/code&gt; whose input is a Reader; and</div><div class="line"> * &lt;li&gt;&#123;<span class="doctag">@link</span> TokenFilter&#125;, a &lt;code&gt;TokenStream&lt;/code&gt; whose input is another</div><div class="line"> * &lt;code&gt;TokenStream&lt;/code&gt;.</div><div class="line"> * &lt;/ul&gt;</div><div class="line"> * A new &lt;code&gt;TokenStream&lt;/code&gt; API has been introduced with Lucene 2.9. This API</div><div class="line"> * has moved from being &#123;<span class="doctag">@link</span> Token&#125;-based to &#123;<span class="doctag">@link</span> Attribute&#125;-based. While</div><div class="line"> * &#123;<span class="doctag">@link</span> Token&#125; still exists in 2.9 as a convenience class, the preferred way</div><div class="line"> * to store the information of a &#123;<span class="doctag">@link</span> Token&#125; is to use &#123;<span class="doctag">@link</span> AttributeImpl&#125;s.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;code&gt;TokenStream&lt;/code&gt; now extends &#123;<span class="doctag">@link</span> AttributeSource&#125;, which provides</div><div class="line"> * access to all of the token &#123;<span class="doctag">@link</span> Attribute&#125;s for the &lt;code&gt;TokenStream&lt;/code&gt;.</div><div class="line"> * Note that only one instance per &#123;<span class="doctag">@link</span> AttributeImpl&#125; is created and reused</div><div class="line"> * for every token. This approach reduces object creation and allows local</div><div class="line"> * caching of references to the &#123;<span class="doctag">@link</span> AttributeImpl&#125;s. See</div><div class="line"> * &#123;<span class="doctag">@link</span> #incrementToken()&#125; for further details.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * &lt;b&gt;The workflow of the new &lt;code&gt;TokenStream&lt;/code&gt; API is as follows:&lt;/b&gt;</div><div class="line"> * &lt;ol&gt;</div><div class="line"> * &lt;li&gt;Instantiation of &lt;code&gt;TokenStream&lt;/code&gt;/&#123;<span class="doctag">@link</span> TokenFilter&#125;s which add/get</div><div class="line"> * attributes to/from the &#123;<span class="doctag">@link</span> AttributeSource&#125;.</div><div class="line"> * &lt;li&gt;The consumer calls &#123;<span class="doctag">@link</span> TokenStream#reset()&#125;.</div><div class="line"> * &lt;li&gt;The consumer retrieves attributes from the stream and stores local</div><div class="line"> * references to all attributes it wants to access.</div><div class="line"> * &lt;li&gt;The consumer calls &#123;<span class="doctag">@link</span> #incrementToken()&#125; until it returns false</div><div class="line"> * consuming the attributes after each call.</div><div class="line"> * &lt;li&gt;The consumer calls &#123;<span class="doctag">@link</span> #end()&#125; so that any end-of-stream operations</div><div class="line"> * can be performed.</div><div class="line"> * &lt;li&gt;The consumer calls &#123;<span class="doctag">@link</span> #close()&#125; to release any resource when finished</div><div class="line"> * using the &lt;code&gt;TokenStream&lt;/code&gt;.</div><div class="line"> * &lt;/ol&gt;</div><div class="line"> * To make sure that filters and consumers know which attributes are available,</div><div class="line"> * the attributes must be added during instantiation. Filters and consumers are</div><div class="line"> * not required to check for availability of attributes in</div><div class="line"> * &#123;<span class="doctag">@link</span> #incrementToken()&#125;.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * You can find some example code for the new API in the analysis package level</div><div class="line"> * Javadoc.</div><div class="line"> * &lt;p&gt;</div><div class="line"> * Sometimes it is desirable to capture a current state of a &lt;code&gt;TokenStream&lt;/code&gt;,</div><div class="line"> * e.g., for buffering purposes (see &#123;<span class="doctag">@link</span> CachingTokenFilter&#125;,</div><div class="line"> * TeeSinkTokenFilter). For this usecase</div><div class="line"> * &#123;<span class="doctag">@link</span> AttributeSource#captureState&#125; and &#123;<span class="doctag">@link</span> AttributeSource#restoreState&#125;</div><div class="line"> * can be used.</div><div class="line"> * &lt;p&gt;The &#123;<span class="doctag">@code</span> TokenStream&#125;-API in Lucene is based on the decorator pattern.</div><div class="line"> * Therefore all non-abstract subclasses must be final or have at least a final</div><div class="line"> * implementation of &#123;<span class="doctag">@link</span> #incrementToken&#125;! This is checked when Java</div><div class="line"> * assertions are enabled.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenStream</span> <span class="keyword">extends</span> <span class="title">AttributeSource</span> <span class="keyword">implements</span> <span class="title">Closeable</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">/** Default &#123;<span class="doctag">@link</span> AttributeFactory&#125; instance that should be used for TokenStreams. */</span></div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> AttributeFactory DEFAULT_TOKEN_ATTRIBUTE_FACTORY =</div><div class="line">    AttributeFactory.getStaticImplementation(AttributeFactory.DEFAULT_ATTRIBUTE_FACTORY, PackedTokenAttributeImpl.class);</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * A TokenStream using the default attribute factory.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">TokenStream</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(DEFAULT_TOKEN_ATTRIBUTE_FACTORY);</div><div class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">assertFinal</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * A TokenStream that uses the same attributes as the supplied one.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">TokenStream</span><span class="params">(AttributeSource input)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(input);</div><div class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">assertFinal</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * A TokenStream using the supplied AttributeFactory for creating new &#123;<span class="doctag">@link</span> Attribute&#125; instances.</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="title">TokenStream</span><span class="params">(AttributeFactory factory)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>(factory);</div><div class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">assertFinal</span><span class="params">()</span></span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">assertFinal</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">final</span> Class&lt;?&gt; clazz = getClass();</div><div class="line">      <span class="keyword">if</span> (!clazz.desiredAssertionStatus())</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">assert</span> clazz.isAnonymousClass() ||</div><div class="line">        (clazz.getModifiers() &amp; (Modifier.FINAL | Modifier.PRIVATE)) != <span class="number">0</span> ||</div><div class="line">        Modifier.isFinal(clazz.getMethod(<span class="string">"incrementToken"</span>).getModifiers()) :</div><div class="line">        <span class="string">"TokenStream implementation classes or at least their incrementToken() implementation must be final"</span>;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (NoSuchMethodException nsme) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * Consumers (i.e., &#123;<span class="doctag">@link</span> IndexWriter&#125;) use this method to advance the stream to</div><div class="line">   * the next token. Implementing classes must implement this method and update</div><div class="line">   * the appropriate &#123;<span class="doctag">@link</span> AttributeImpl&#125;s with the attributes of the next</div><div class="line">   * token.</div><div class="line">   * &lt;P&gt;</div><div class="line">   * The producer must make no assumptions about the attributes after the method</div><div class="line">   * has been returned: the caller may arbitrarily change it. If the producer</div><div class="line">   * needs to preserve the state for subsequent calls, it can use</div><div class="line">   * &#123;<span class="doctag">@link</span> #captureState&#125; to create a copy of the current attribute state.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * This method is called for every token of a document, so an efficient</div><div class="line">   * implementation is crucial for good performance. To avoid calls to</div><div class="line">   * &#123;<span class="doctag">@link</span> #addAttribute(Class)&#125; and &#123;<span class="doctag">@link</span> #getAttribute(Class)&#125;,</div><div class="line">   * references to all &#123;<span class="doctag">@link</span> AttributeImpl&#125;s that this stream uses should be</div><div class="line">   * retrieved during instantiation.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * To ensure that filters and consumers know which attributes are available,</div><div class="line">   * the attributes must be added during instantiation. Filters and consumers</div><div class="line">   * are not required to check for availability of attributes in</div><div class="line">   * &#123;<span class="doctag">@link</span> #incrementToken()&#125;.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@return</span> false for end of stream; true otherwise</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">incrementToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * This method is called by the consumer after the last token has been</div><div class="line">   * consumed, after &#123;<span class="doctag">@link</span> #incrementToken()&#125; returned &lt;code&gt;false&lt;/code&gt;</div><div class="line">   * (using the new &lt;code&gt;TokenStream&lt;/code&gt; API). Streams implementing the old API</div><div class="line">   * should upgrade to use this feature.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * This method can be used to perform any end-of-stream operations, such as</div><div class="line">   * setting the final offset of a stream. The final offset of a stream might</div><div class="line">   * differ from the offset of the last token eg in case one or more whitespaces</div><div class="line">   * followed after the last token, but a WhitespaceTokenizer was used.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * Additionally any skipped positions (such as those removed by a stopfilter)</div><div class="line">   * can be applied to the position increment, or any adjustment of other</div><div class="line">   * attributes where the end-of-stream value may be important.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * If you override this method, always call &#123;<span class="doctag">@code</span> super.end()&#125;.</div><div class="line">   *</div><div class="line">   * <span class="doctag">@throws</span> IOException If an I/O error occurs</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">end</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">    endAttributes(); <span class="comment">// LUCENE-3849: don't consume dirty atts</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">/**</span></div><div class="line">   * This method is called by a consumer before it begins consumption using</div><div class="line">   * &#123;<span class="doctag">@link</span> #incrementToken()&#125;.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * Resets this stream to a clean state. Stateful implementations must implement</div><div class="line">   * this method so that they can be reused, just as if they had been created fresh.</div><div class="line">   * &lt;p&gt;</div><div class="line">   * If you override this method, always call &#123;<span class="doctag">@code</span> super.reset()&#125;, otherwise</div><div class="line">   * some internal state will not be correctly reset (e.g., &#123;<span class="doctag">@link</span> Tokenizer&#125; will</div><div class="line">   * throw &#123;<span class="doctag">@link</span> IllegalStateException&#125; on further usage).</div><div class="line">   */</div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;&#125;</div><div class="line"></div><div class="line">  <span class="comment">/** Releases resources associated with this stream.</span></div><div class="line">   * &lt;p&gt;</div><div class="line">   * If you override this method, always call &#123;<span class="doctag">@code</span> super.close()&#125;, otherwise</div><div class="line">   * some internal state will not be correctly reset (e.g., &#123;<span class="doctag">@link</span> Tokenizer&#125; will</div><div class="line">   * throw &#123;<span class="doctag">@link</span> IllegalStateException&#125; on reuse).</div><div class="line">   */</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上，每一个<code>TokenStream</code>之间相互协调，通过<code>incrementToken()</code>方法串成了一条责任链。</p>
<p>以上面 sample 为例，在索引 <code>content</code> 字段的时候 TokenStream 链路是这样的：<br><code>StandardTokenizer</code> —&gt; <code>StandardFilter</code> —&gt; <code>LowerCaseFilter</code> —&gt; <code>FilteringTokenFilter</code></p>
<p>Tokenizer 作为 Stream 的起点，直接通过<code>java.io.Reader</code>读取文件流数据，而其余<code>TokenFilter</code>则从其他的<code>TokenStream</code>中读取数据。</p>
<p>我们现在来看看链路的起点<code>StandardTokenizer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/** A private instance of the JFlex-constructed scanner */</span></div><div class="line"><span class="keyword">private</span> StandardTokenizerImpl scanner;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">this</span>.scanner = <span class="keyword">new</span> StandardTokenizerImpl(input);</div><div class="line">&#125;</div><div class="line"><span class="comment">// this tokenizer generates three attributes:</span></div><div class="line"><span class="comment">// term offset, positionIncrement and type</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> CharTermAttribute termAtt = addAttribute(CharTermAttribute.class);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> OffsetAttribute offsetAtt = addAttribute(OffsetAttribute.class);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> PositionIncrementAttribute posIncrAtt = addAttribute(PositionIncrementAttribute.class);</div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeAttribute typeAtt = addAttribute(TypeAttribute.class);</div><div class="line"><span class="comment">/*</span></div><div class="line"> * (non-Javadoc)</div><div class="line"> *</div><div class="line"> * @see org.apache.lucene.analysis.TokenStream#next()</div><div class="line"> */</div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">incrementToken</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  clearAttributes();</div><div class="line">  skippedPositions = <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</div><div class="line">    <span class="keyword">int</span> tokenType = scanner.getNextToken();</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (tokenType == StandardTokenizerImpl.YYEOF) &#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (scanner.yylength() &lt;= maxTokenLength) &#123;</div><div class="line">      posIncrAtt.setPositionIncrement(skippedPositions+<span class="number">1</span>);</div><div class="line">      scanner.getText(termAtt);</div><div class="line">      <span class="keyword">final</span> <span class="keyword">int</span> start = scanner.yychar();</div><div class="line">      offsetAtt.setOffset(correctOffset(start), correctOffset(start+termAtt.length()));</div><div class="line">      typeAtt.setType(StandardTokenizer.TOKEN_TYPES[tokenType]);</div><div class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span></div><div class="line">      <span class="comment">// When we skip a too-long term, we still increment the</span></div><div class="line">      <span class="comment">// position increment</span></div><div class="line">      skippedPositions++;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>scanner.getText(termAtt);</code>实际上就是根据 Word Break 规则将词提取出来，而后续的<code>TokenFilter</code>只是对提取出来的 token 再次加工。</p>
<h3 id="Token-数据结构"><a href="#Token-数据结构" class="headerlink" title="Token 数据结构"></a>Token 数据结构</h3><p>一个 Token 包含 Offset Attribute , Term Attribute 以及 Type Attribute 三个元素<br><img src="/2017/02/27/Lucene学习笔记一（附源码分析）/token.png" alt="Token 数据结构"><br>这个在 <code>StandardTokenizer:incrementToken()</code>方法的源码中也是有体现的</p>

        </div>
        <footer class="article-footer">
            



    <a data-url="https://leonlibraries.github.io/2017/02/27/Lucene学习笔记一（附源码分析）/" data-id="cj1hfe72k000h70676k87gm6a" class="article-share-link"><i class="fa fa-share"></i>分享到</a>
<script>
    (function ($) {
        $('body').on('click', function() {
            $('.article-share-box.on').removeClass('on');
        }).on('click', '.article-share-link', function(e) {
            e.stopPropagation();

            var $this = $(this),
                url = $this.attr('data-url'),
                encodedUrl = encodeURIComponent(url),
                id = 'article-share-box-' + $this.attr('data-id'),
                offset = $this.offset(),
                box;

            if ($('#' + id).length) {
                box = $('#' + id);

                if (box.hasClass('on')){
                    box.removeClass('on');
                    return;
                }
            } else {
                var html = [
                    '<div id="' + id + '" class="article-share-box">',
                        '<input class="article-share-input" value="' + url + '">',
                        '<div class="article-share-links">',
                            '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
                            '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
                            '<a href="http://pinterest.com/pin/create/button/?url=' + encodedUrl + '" class="article-share-pinterest" target="_blank" title="Pinterest"></a>',
                            '<a href="https://plus.google.com/share?url=' + encodedUrl + '" class="article-share-google" target="_blank" title="Google+"></a>',
                        '</div>',
                    '</div>'
                ].join('');

              box = $(html);

              $('body').append(box);
            }

            $('.article-share-box.on').hide();

            box.css({
                top: offset.top + 25,
                left: offset.left
            }).addClass('on');

        }).on('click', '.article-share-box', function (e) {
            e.stopPropagation();
        }).on('click', '.article-share-box-input', function () {
            $(this).select();
        }).on('click', '.article-share-box-link', function (e) {
            e.preventDefault();
            e.stopPropagation();

            window.open(this.href, 'article-share-box-window-' + Date.now(), 'width=500,height=450');
        });
    })(jQuery);
</script>

        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="twitter" href="/" target="_blank">
                        <i class="icon fa fa-twitter"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="facebook" href="/" target="_blank">
                        <i class="icon fa fa-facebook"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="google-plus" href="/" target="_blank">
                        <i class="icon fa fa-google-plus"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/ppoffice/hexo-theme-hueman" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="weibo" href="/" target="_blank">
                        <i class="icon fa fa-weibo"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2017/04/13/CDH安装运维小记/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            CDH安装运维小记
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2016/06/13/摸清Java并发安全的套路/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">摸清Java并发安全的套路</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/15/ElasticSearch内部机制浅析一/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/15/ElasticSearch内部机制浅析一/framework.jpg)" alt="ElasticSearch 内部机制浅析（一）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/15/ElasticSearch内部机制浅析一/" class="title">ElasticSearch 内部机制浅析（一）</a></p>
                            <p class="item-date"><time datetime="2017-04-15T04:00:15.000Z" itemprop="datePublished">2017-04-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/14/JVM监控工具小记/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/14/JVM监控工具小记/apm.jpeg)" alt="JVM 监控工具小记" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/APM/">APM</a></p>
                            <p class="item-title"><a href="/2017/04/14/JVM监控工具小记/" class="title">JVM 监控工具小记</a></p>
                            <p class="item-date"><time datetime="2017-04-14T04:00:15.000Z" itemprop="datePublished">2017-04-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/13/初涉HBase/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/13/初涉HBase/datastructure1.jpg)" alt="初涉 HBase" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/13/初涉HBase/" class="title">初涉 HBase</a></p>
                            <p class="item-date"><time datetime="2017-04-13T07:56:15.000Z" itemprop="datePublished">2017-04-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/13/CDH安装运维小记/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/13/CDH安装运维小记/deploy.jpeg)" alt="CDH安装运维小记" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/13/CDH安装运维小记/" class="title">CDH安装运维小记</a></p>
                            <p class="item-date"><time datetime="2017-04-13T02:27:15.000Z" itemprop="datePublished">2017-04-13</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/02/27/Lucene学习笔记一（附源码分析）/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/02/27/Lucene学习笔记一（附源码分析）/full-text-searching.jpg)" alt="Lucene 学习笔记一（附源码分析）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/全文搜索/">全文搜索</a></p>
                            <p class="item-title"><a href="/2017/02/27/Lucene学习笔记一（附源码分析）/" class="title">Lucene 学习笔记一（附源码分析）</a></p>
                            <p class="item-date"><time datetime="2017-02-27T02:27:15.000Z" itemprop="datePublished">2017-02-27</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/APM/">APM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码设计/">代码设计</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/全文搜索/">全文搜索</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端那些事儿/">前端那些事儿</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/当我们在谈论多线程的时候，我们在谈论什么/">当我们在谈论多线程的时候，我们在谈论什么</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/">CDH</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECMAScript6/">ECMAScript6</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Relay/">Relay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/StupidIE/">StupidIE</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/full-text-search/">full-text search</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lucene/">lucene</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web前端/">web前端</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码设计/">代码设计</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/全文搜索/">全文搜索</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图片搜索/">图片搜索</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/干货/">干货</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发编程/">并发编程</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模块化/">模块化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/监控/">监控</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面向对象/">面向对象</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/ECMAScript6/" style="font-size: 15px;">ECMAScript6</a> <a href="/tags/HBase/" style="font-size: 12.5px;">HBase</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Java/" style="font-size: 17.5px;">Java</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Relay/" style="font-size: 10px;">Relay</a> <a href="/tags/StupidIE/" style="font-size: 10px;">StupidIE</a> <a href="/tags/full-text-search/" style="font-size: 10px;">full-text search</a> <a href="/tags/lucene/" style="font-size: 10px;">lucene</a> <a href="/tags/web前端/" style="font-size: 20px;">web前端</a> <a href="/tags/代码设计/" style="font-size: 10px;">代码设计</a> <a href="/tags/全文搜索/" style="font-size: 10px;">全文搜索</a> <a href="/tags/图片搜索/" style="font-size: 10px;">图片搜索</a> <a href="/tags/大数据/" style="font-size: 15px;">大数据</a> <a href="/tags/干货/" style="font-size: 10px;">干货</a> <a href="/tags/并发编程/" style="font-size: 12.5px;">并发编程</a> <a href="/tags/架构/" style="font-size: 10px;">架构</a> <a href="/tags/模块化/" style="font-size: 10px;">模块化</a> <a href="/tags/监控/" style="font-size: 10px;">监控</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a> <a href="/tags/面向对象/" style="font-size: 10px;">面向对象</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="http://hexo.io">Hexo</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2017 雨夜偷牛的人</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'https://leonlibraries.github.io/2017/02/27/Lucene学习笔记一（附源码分析）/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
