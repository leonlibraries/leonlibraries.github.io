<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>ElasticSearch 内部机制浅析（三） | 茅屋为秋风所破歌</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
        <meta name="keywords" content="大数据,Java,全文搜索,Lucene" />
    
    <meta name="description" content="前言上篇从分布式的角度阐述了 ES 的分布式设计和思想，这一篇打算与 Lucene 结合起来，摸透一些 ES 的常遇到的概念，我们可以将了解到的这些东西应用到优化实践中去。
废话不多说，进入正题。
ShardShard 实际上是一个 Lucene 的一个实例（Lucene Index），但往往一个 Elastic Index 都是由多个 Shards （primary &amp;amp; replica）">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch 内部机制浅析（三）">
<meta property="og:url" content="https://leonlibraries.github.io/2017/04/27/ElasticSearch内部机制浅析三/index.html">
<meta property="og:site_name" content="茅屋为秋风所破歌">
<meta property="og:description" content="前言上篇从分布式的角度阐述了 ES 的分布式设计和思想，这一篇打算与 Lucene 结合起来，摸透一些 ES 的常遇到的概念，我们可以将了解到的这些东西应用到优化实践中去。
废话不多说，进入正题。
ShardShard 实际上是一个 Lucene 的一个实例（Lucene Index），但往往一个 Elastic Index 都是由多个 Shards （primary &amp;amp; replica）">
<meta property="og:image" content="https://leonlibraries.github.io/2017/04/27/ElasticSearch内部机制浅析三/segments.jpg">
<meta property="og:updated_time" content="2017-05-02T02:56:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ElasticSearch 内部机制浅析（三）">
<meta name="twitter:description" content="前言上篇从分布式的角度阐述了 ES 的分布式设计和思想，这一篇打算与 Lucene 结合起来，摸透一些 ES 的常遇到的概念，我们可以将了解到的这些东西应用到优化实践中去。
废话不多说，进入正题。
ShardShard 实际上是一个 Lucene 的一个实例（Lucene Index），但往往一个 Elastic Index 都是由多个 Shards （primary &amp;amp; replica）">
<meta name="twitter:image" content="https://leonlibraries.github.io/2017/04/27/ElasticSearch内部机制浅析三/segments.jpg">
    

    
        <link rel="alternate" href="/" title="茅屋为秋风所破歌" type="application/atom+xml" />
    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.0.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    
    
        <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?2be7dcbaf7515622e413315f4dcb7c53";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

    

</head>

<body>
    <div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">技术心得分享</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item" >
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/APM/">APM</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/代码设计/">代码设计</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/全文搜索/">全文搜索</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/前端那些事儿/">前端那些事儿</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/大数据/">大数据</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/当我们在谈论多线程的时候，我们在谈论什么/">当我们在谈论多线程的时候，我们在谈论什么</a></li></ul>
                                    
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/大数据/">大数据</a>
    </h1>
</div>
                        <div class="main-body-content">
                            <article id="post-ElasticSearch内部机制浅析三" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        ElasticSearch 内部机制浅析（三）
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
        <a href="/2017/04/27/ElasticSearch内部机制浅析三/" class="article-date">
            <time datetime="2017-04-27T09:00:15.000Z" itemprop="datePublished">2017-04-27</time>
        </a>
    </div>

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Java/">Java</a>, <a class="tag-link" href="/tags/Lucene/">Lucene</a>, <a class="tag-link" href="/tags/全文搜索/">全文搜索</a>, <a class="tag-link" href="/tags/大数据/">大数据</a>
    </div>

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>上篇从分布式的角度阐述了 ES 的分布式设计和思想，这一篇打算与 Lucene 结合起来，摸透一些 ES 的常遇到的概念，我们可以将了解到的这些东西应用到优化实践中去。</p>
<p>废话不多说，进入正题。</p>
<h2 id="Shard"><a href="#Shard" class="headerlink" title="Shard"></a>Shard</h2><p>Shard 实际上是一个 Lucene 的一个实例（Lucene Index），但往往一个 Elastic Index 都是由多个 Shards （primary &amp; replica）构成的。<br>特别注意，在单个 Lucene 实例里最多包含<code>2,147,483,519 (= Integer.MAX_VALUE - 128)</code> 个 Documents。</p>
<blockquote>
<p>可以利用 _cat/shards API 来监控 shards 大小。</p>
</blockquote>
<h2 id="Lucene-Index-结构"><a href="#Lucene-Index-结构" class="headerlink" title="Lucene Index 结构"></a>Lucene Index 结构</h2><p>一个 <em>Lucene Index</em> 在文件系统的表现上来看就是存储了一系列文件的一个目录。一个 <em>Lucene Index</em> 由许多独立的 <em>segments</em> 组成，而 <em>segments</em> 包含了文档中的词汇字典、词汇字典的倒排索引以及 Document 的字段数据（设置为<code>Stored.YES</code>的字段），所有的 <em>segments</em> 数据存储于 <code>_&lt;segment_name&gt;.cfs</code>的文件中。</p>
<h2 id="Segments"><a href="#Segments" class="headerlink" title="Segments"></a>Segments</h2><p><img src="/2017/04/27/ElasticSearch内部机制浅析三/segments.jpg" alt=""><br>Segment 直接提供了搜索功能的，ES 的一个 Shard （Lucene Index）中是由大量的 Segment 文件组成的，且每一次 <em>fresh</em> 都会产生一个新的 Segment 文件，这样一来 Segment 文件有大有小，相当碎片化。ES 内部则会开启一个线程将小的 Segment 合并（Merge）成大的 Segment，减少碎片化，降低文件打开数，提升 I/O 性能。</p>
<blockquote>
<p>Segment 文件是不可变更的。当一个 Document 更新的时候，实际上是将旧的文档标记为删除，然后索引一个新的文档。在 Merge 的过程中会将旧的 Document 删除掉。具体到文件系统来说，文档 A 是写入到 <code>_&lt;segment_name&gt;.cfs</code> 文件里的，删除文档 A 实际上是在<code>_&lt;segment_name&gt;.del</code>文件里标记某个 document 已被删除，那么下次查询的时候则会跳过这个文档，是为逻辑删除。当归并（Merge）的时候，老的 segment 文件将会被删除，合并成新的 segment 文件，这个时候也就是物理删除了。</p>
</blockquote>
<h2 id="Type-or-Index？"><a href="#Type-or-Index？" class="headerlink" title="Type or Index？"></a>Type or Index？</h2><p>先来看看一个比较完备的 Schema<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="string">"zipkin-2017-03-01"</span>: &#123;</div><div class="line">        <span class="string">"aliases"</span>: &#123;&#125;,</div><div class="line">        <span class="string">"mappings"</span>: &#123;</div><div class="line">            <span class="string">"_default_"</span>: &#123;</div><div class="line">                <span class="string">"_all"</span>: &#123;</div><div class="line">                    <span class="string">"enabled"</span>: <span class="literal">false</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"dynamic_templates"</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"strings"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"*"</span>,</div><div class="line">                            <span class="string">"match_mapping_type"</span>: <span class="string">"string"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span>,</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"value"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"value"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span>,</div><div class="line">                                <span class="string">"ignore_malformed"</span>: <span class="literal">true</span>,</div><div class="line">                                <span class="string">"match_mapping_type"</span>: <span class="string">"string"</span>,</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"annotations"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"annotations"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"nested"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"binaryAnnotations"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"binaryAnnotations"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"nested"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                ]</div><div class="line">            &#125;,</div><div class="line">            <span class="string">"span"</span>: &#123;</div><div class="line">                <span class="string">"_all"</span>: &#123;</div><div class="line">                    <span class="string">"enabled"</span>: <span class="literal">false</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"dynamic_templates"</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"strings"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"*"</span>,</div><div class="line">                            <span class="string">"match_mapping_type"</span>: <span class="string">"string"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span>,</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"value"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"value"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span>,</div><div class="line">                                <span class="string">"ignore_malformed"</span>: <span class="literal">true</span>,</div><div class="line">                                <span class="string">"match_mapping_type"</span>: <span class="string">"string"</span>,</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"annotations"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"annotations"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"nested"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"binaryAnnotations"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"binaryAnnotations"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"nested"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                ],</div><div class="line">                <span class="string">"properties"</span>: &#123;</div><div class="line">                    <span class="string">"annotations"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"nested"</span>,</div><div class="line">                        <span class="string">"properties"</span>: &#123;</div><div class="line">                            <span class="string">"endpoint"</span>: &#123;</div><div class="line">                                <span class="string">"properties"</span>: &#123;</div><div class="line">                                    <span class="string">"ipv4"</span>: &#123;</div><div class="line">                                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                                    &#125;,</div><div class="line">                                    <span class="string">"serviceName"</span>: &#123;</div><div class="line">                                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125;,</div><div class="line">                            <span class="string">"timestamp"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                            &#125;,</div><div class="line">                            <span class="string">"value"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"binaryAnnotations"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"nested"</span>,</div><div class="line">                        <span class="string">"properties"</span>: &#123;</div><div class="line">                            <span class="string">"endpoint"</span>: &#123;</div><div class="line">                                <span class="string">"properties"</span>: &#123;</div><div class="line">                                    <span class="string">"ipv4"</span>: &#123;</div><div class="line">                                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                                    &#125;,</div><div class="line">                                    <span class="string">"port"</span>: &#123;</div><div class="line">                                        <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                                    &#125;,</div><div class="line">                                    <span class="string">"serviceName"</span>: &#123;</div><div class="line">                                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                                    &#125;</div><div class="line">                                &#125;</div><div class="line">                            &#125;,</div><div class="line">                            <span class="string">"key"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                            &#125;,</div><div class="line">                            <span class="string">"value"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"duration"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"id"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"name"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"parentId"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"timestamp"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"timestamp_millis"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"date"</span>,</div><div class="line">                        <span class="string">"format"</span>: <span class="string">"epoch_millis"</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"traceId"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            <span class="string">"dependencylink"</span>: &#123;</div><div class="line">                <span class="string">"_all"</span>: &#123;</div><div class="line">                    <span class="string">"enabled"</span>: <span class="literal">false</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">"dynamic_templates"</span>: [</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"strings"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"*"</span>,</div><div class="line">                            <span class="string">"match_mapping_type"</span>: <span class="string">"string"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span>,</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"value"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"value"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"ignore_above"</span>: <span class="number">256</span>,</div><div class="line">                                <span class="string">"ignore_malformed"</span>: <span class="literal">true</span>,</div><div class="line">                                <span class="string">"match_mapping_type"</span>: <span class="string">"string"</span>,</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"keyword"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"annotations"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"annotations"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"nested"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    &#123;</div><div class="line">                        <span class="string">"binaryAnnotations"</span>: &#123;</div><div class="line">                            <span class="string">"match"</span>: <span class="string">"binaryAnnotations"</span>,</div><div class="line">                            <span class="string">"mapping"</span>: &#123;</div><div class="line">                                <span class="string">"type"</span>: <span class="string">"nested"</span></div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                ],</div><div class="line">                <span class="string">"properties"</span>: &#123;</div><div class="line">                    <span class="string">"callCount"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"long"</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"child"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"id"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"parent"</span>: &#123;</div><div class="line">                        <span class="string">"type"</span>: <span class="string">"keyword"</span>,</div><div class="line">                        <span class="string">"ignore_above"</span>: <span class="number">256</span></div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;,</div><div class="line">        <span class="string">"settings"</span>: &#123;</div><div class="line">            <span class="string">"index"</span>: &#123;</div><div class="line">                <span class="string">"number_of_shards"</span>: <span class="string">"6"</span>,</div><div class="line">                <span class="string">"provided_name"</span>: <span class="string">"zipkin-2017-03-01"</span>,</div><div class="line">                <span class="string">"creation_date"</span>: <span class="string">"1488328116434"</span>,</div><div class="line">                <span class="string">"requests"</span>: &#123;</div><div class="line">                    <span class="string">"cache"</span>: &#123;</div><div class="line">                        <span class="string">"enable"</span>: <span class="string">"true"</span></div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"analysis"</span>: &#123;</div><div class="line">                    <span class="string">"filter"</span>: &#123;</div><div class="line">                        <span class="string">"traceId_filter"</span>: &#123;</div><div class="line">                            <span class="string">"type"</span>: <span class="string">"pattern_capture"</span>,</div><div class="line">                            <span class="string">"preserve_original"</span>: <span class="string">"true"</span>,</div><div class="line">                            <span class="string">"patterns"</span>: [</div><div class="line">                                <span class="string">"([0-9a-f]&#123;1,16&#125;)$"</span></div><div class="line">                            ]</div><div class="line">                        &#125;</div><div class="line">                    &#125;,</div><div class="line">                    <span class="string">"analyzer"</span>: &#123;</div><div class="line">                        <span class="string">"traceId_analyzer"</span>: &#123;</div><div class="line">                            <span class="string">"filter"</span>: <span class="string">"traceId_filter"</span>,</div><div class="line">                            <span class="string">"type"</span>: <span class="string">"custom"</span>,</div><div class="line">                            <span class="string">"tokenizer"</span>: <span class="string">"keyword"</span></div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;,</div><div class="line">                <span class="string">"number_of_replicas"</span>: <span class="string">"2"</span>,</div><div class="line">                <span class="string">"uuid"</span>: <span class="string">"_9j3jYVDRbOp8rOec8fEqw"</span>,</div><div class="line">                <span class="string">"version"</span>: &#123;</div><div class="line">                    <span class="string">"created"</span>: <span class="string">"5020199"</span></div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里的 <code>zipkin-2017-03-01</code> 是 Index name，<code>span</code> 和 <code>dependencylink</code> 是 Type name。很多人在前期规范 Schema 的时候犯难，不知道应该直接用 Type 表示数据 Schema 好还是新建一个 Index ？这里接下来会进一步探讨。</p>
<ul>
<li>Index 有何局限？</li>
</ul>
<p>当需要对大量的 index 做聚合查询的时候，是将 index中的每一个分片单独查询，再将结果聚合出来，如果量级特别大，那么占用的 CPU 和内存资源将会十分庞大；</p>
<ul>
<li>Type 呢？</li>
</ul>
<p>在同一个 Index 下，可以通过 <code>_Type</code> 字段指定不同的 Type，其中无论多少个 Type 的聚合查询，shard 数目维持不变，因此聚合所消耗的资源大量减少，然而也会有一定的限制：</p>
<p>① 同一 Index 下，同名 Field 类型必须相同，即使不同的 Type；<br>② 同一 Index 下，TypeA 的 Field 会占用 TypeB 的资源（互相消耗资源），会形成一种稀疏存储的情况。尤其是 doc value ，为什么这么说呢？doc value为了性能考虑会保留一部分的磁盘空间，这意味着 TypeB 可能不需要这个字段的 doc_value 而 TypeA 需要，那么 TypeB 就被白白占用了一部分没有半点用处的资源；<br>③ 同理，Score 评分机制是 index-wide 的，这会导致评分受到影响。</p>
<p>ES 本身是 Schemaless 的，意味着你前期设计需要更多的花费心思，没有类似于 RDB 的范式。原则上来说，只要基本尊重范式要求，关系型数据库的设计问题都不大，而对于 Schemaless 的 ES 来说，前期设计数据结构的时候需要多花费点心思。</p>
<p>基本来说，数据关联度不大的不建议放到同一个 Index 且以 Type 来区分，如果考虑到 Index 分片过大导致后续检索压力增加的情况，应该对 Index进行拆分，ES 的通常做法是，以时间为维度做数据拆分，比如一天一个 Index 或者一个月一个 Index，依据数据量大小来衡量。</p>
<blockquote>
<p><strong>tips：</strong> 对于字段信息变更频繁的数据， 也不适合与其他 Index 存在一起且以 Type 来区分。因为在 ES 中，索引元数据本身是放在主节点中维护的，CP 设计。意味着涉及到大量字段变更及元数据变更的操作，都会导致该 Index 被堵塞或假死。我们应该对这样的 Index 做隔离，避免影响到其他 Index 正常的增删改查。甚至当涉及到字段变更十分频繁且无法预定义 schema 的场景时，是否要使用 ES 都应该慎思熟虑了！</p>
</blockquote>
<h2 id="source-amp-all-amp-field-names字段"><a href="#source-amp-all-amp-field-names字段" class="headerlink" title="_source &amp; _all &amp; _field_names字段"></a><code>_source</code> &amp; <code>_all</code> &amp; <code>_field_names</code>字段</h2><p>在定义某个 Index 的 schema 的时候，涉及到这几个参数，任何事情都不是一概而论的，因此需要结合具体场景考量一下这些参数设置的意图。</p>
<ul>
<li><code>_source</code> ：Lucene 对于源文档的存储提供了一个选项（Stored.YES/NO），如果选了YES，其数据就会检索的过程中返回；否则 Lucene 即使成功做了检索，也只能返回数据的 ID，然后借助第三方存储通过 ID 将数据查询出来。该参数默认<code>enabled</code>，表示需要将文档原始数据一并存入索引之中，<code>disabled</code>则表示我的 Lucene 实例中只包含倒排索引以及词典，不对原始文档做持久化；</li>
<li><code>_all</code> ：默认<code>enabled</code>，意思是需要用额外的存储空间存储该 Index 的各字段信息以及数据，目的是检索的过程中可以不需要指定任何字段，也即是全字段匹配；对于字段结构简单的，可以 <code>disabled</code> 取消掉这块功能；</li>
<li><code>_field_names</code> 字段 ：这个字段默认开启，存储的是每个 document 中的字段名，如果没有检查 Document 的字段是否存在这样类似的需求的话，建议关闭，写入性能大约提升20%。</li>
</ul>
<h2 id="doc-value"><a href="#doc-value" class="headerlink" title="doc_value"></a><code>doc_value</code></h2><p>之前介绍过，倒排索引的数据组织方式大概是这样的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Term      Doc_1   Doc_2   Doc_3</div><div class="line">------------------------------------</div><div class="line">brown   |   X   |   X   |</div><div class="line">dog     |   X   |       |   X</div><div class="line">dogs    |       |   X   |   X</div><div class="line">fox     |   X   |       |   X</div><div class="line">foxes   |       |   X   |</div><div class="line">in      |       |   X   |</div><div class="line">jumped  |   X   |       |   X</div><div class="line">lazy    |   X   |   X   |</div><div class="line">leap    |       |   X   |</div><div class="line">over    |   X   |   X   |   X</div><div class="line">quick   |   X   |   X   |   X</div><div class="line">summer  |       |   X   |</div><div class="line">the     |   X   |       |   X</div><div class="line">------------------------------------</div></pre></td></tr></table></figure></p>
<p>如果我要查询包含 <code>brown</code> 的文档有哪些？这个就是全文检索了，也相当好办，先从词典里遍历到 <code>brown</code> 这个单词，然后根据倒排索引查得 Doc_1 和 Doc_2 包含这个单词。那如果我要查 Doc_1 和 Doc_2 包含的单词分别有什么？这个用倒排索引的话开销会非常大，至少是要将整张表关于 Doc_1 和 Doc_2 的列数据遍历一遍才行。这时候我们将数据换一种组织形式，将会起到非常好的效果。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Doc      Terms</div><div class="line">-----------------------------------------------------------------</div><div class="line">Doc_1 | brown, dog, fox, jumped, lazy, over, quick, the</div><div class="line">Doc_2 | brown, dogs, foxes, in, lazy, leap, over, quick, summer</div><div class="line">Doc_3 | dog, dogs, fox, jumped, over, quick, the</div><div class="line">-----------------------------------------------------------------</div></pre></td></tr></table></figure></p>
<p>Doc_1 和 Doc_2 存了什么单词，一目了然。<br>当然对于数字类型的字段也是一样的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Doc      Metric</div><div class="line">-----------------------------------------------------------------</div><div class="line">Doc_1 | 0.2f</div><div class="line">Doc_2 | 9.3f</div><div class="line">Doc_3 | 5.6f</div><div class="line">-----------------------------------------------------------------</div></pre></td></tr></table></figure></p>
<p>我们把这种数据的组织方式叫做<code>doc_value</code>。</p>
<blockquote>
<p>倒排索引的特点很明显，就是为了全文检索而生的，但是对于一些聚合查询（排序、求平均值等等）的场景来说，显然不适用。那么这样一来我们为了应对一些聚合场景就需要结构化数据来应付，这里说的结构化数据就是『列存储』，也就是上面说的<code>doc_value</code>。</p>
<p>When searching, we need to be able to map a term to a list of documents.When sorting, we need to map a document to its terms. In other words, we need to “uninvert” the inverted index.This “uninverted” structure is often called a “column-store” in other systems. Essentially, it stores all the values for a single field together in a single column of data, which makes it very efficient for operations like sorting</p>
</blockquote>
<p><code>doc_value</code>在 ES 中有几个应用场景：</p>
<ul>
<li>对某个字段排序；</li>
<li>某个字段聚合查询（ max/min/count ）；</li>
<li>部分过滤器 （ 地理位置过滤器 ）；</li>
<li>某个字段的脚本执行。等等。</li>
</ul>
<p><code>doc_value</code>是顺序存储到磁盘的，因此访问是很快的。当我们所处理的集合小于所给的 JVM 堆内存，那么整个数据集合是会被加载到内存里的；如果数据集合大于所给的堆内存，那么就会分页加载到内存之中，而不会报出『OutOfMemory Error』。</p>
<h2 id="父子关系树构建"><a href="#父子关系树构建" class="headerlink" title="父子关系树构建"></a>父子关系树构建</h2><p>上面介绍了<code>doc_value</code>，有个很重要的应用便是利用<code>doc_value</code>构建父子关系的树。这里说的父和子实际上是两个独立的 document，所以和嵌套对象（nested objects）是不一样的，关于嵌套对象会在未来的文章里叙述。这样父子节点独立存储的好处是，父与子之间的更新或者增加节点都不会相互影响，也不需要重建索引。<br>那么 ES 是如何构建父子树呢？<br>ES 通过<code>doc_value</code>维护了一套父子关系，类似如下数据组织方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Doc    _id      parentId</div><div class="line">-----------------------------------------------------------------</div><div class="line">Doc_1 | 1 |</div><div class="line">Doc_2 | 2 | 1</div><div class="line">Doc_3 | 3 | 1</div><div class="line">-----------------------------------------------------------------</div></pre></td></tr></table></figure></p>
<p>这一套数据之前提及过，是在内存里维护的（当然数据超出内存大小后是可以做分页的），而这就意味着：<br><strong>父节点和其所有子节点必须在同一个 shard 之中！</strong></p>
<h2 id="时间序列数据库（TSDB）"><a href="#时间序列数据库（TSDB）" class="headerlink" title="时间序列数据库（TSDB）"></a>时间序列数据库（TSDB）</h2><p>从上面的参数我们引出这么一个问题，如何利用 ES 做 TSDB（时序数据库）？</p>
<p>首先我们需要知道 TSDB 需要什么不需要什么，原则来说，TSDB 是以时间作为索引的，其数据结构越简单越好，层次最好就一层，字段固定且单一，大致包含了<code>&lt;id,timestamp,metric&gt;</code>这几个参数，对硬盘的占用也需要做优化，系统高可用性比强一致性要重要一些，对 PB 级别的数据的处理有极低的延迟等等。</p>
<p>系统中每一条记录代表某个时间节点下某样事物的指标，可以是业务指标，也可以是机器/服务性能指标。指标本身数据简单，但是很可能每隔一秒或一分钟就要收集一次指标，从长远来看将会产生十分庞大的数据，并且还要对这样庞大的数据做聚合查询，统计分析等等。<br>根据这个思路，我们可以对 ES 的 schema 做出如下优化，使之成为一个合格的 TSDB：</p>
<ul>
<li>禁用 <code>_source</code> &amp; <code>_all</code>，TSDB 并不需要存储指标原文，更不需要对指标本身做全文检索；</li>
<li>启用<code>doc_value</code>字段，提供聚合查询的支持，后续会做详细介绍；</li>
<li>字段类型能用 float 就不用 double；</li>
<li>长期来看，为了合理的优化存储，我们可以周期性执行 <code>/_forcemerge</code> 方法合并碎片，优化存储空间。</li>
</ul>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>本文部分结合了 Lucene 来考究 ES 的特性，以及对具体的应用场景做了一定程度的探讨。</p>
<p>推荐阅读：<br><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/reference/current/_basic_concepts.html</a><br><a href="http://stackoverflow.com/questions/15426441/understanding-segments-in-elasticsearch" target="_blank" rel="external">http://stackoverflow.com/questions/15426441/understanding-segments-in-elasticsearch</a><br><a href="https://www.elastic.co/blog/lucenes-handling-of-deleted-documents" target="_blank" rel="external">https://www.elastic.co/blog/lucenes-handling-of-deleted-documents</a><br><a href="https://framework.zend.com/manual/1.10/en/learning.lucene.index-structure.html" target="_blank" rel="external">https://framework.zend.com/manual/1.10/en/learning.lucene.index-structure.html</a><br><a href="https://www.elastic.co/blog/elasticsearch-as-a-time-series-data-store" target="_blank" rel="external">https://www.elastic.co/blog/elasticsearch-as-a-time-series-data-store</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/docvalues.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/2.x/docvalues.html</a><br><a href="https://taowen.gitbooks.io/tsdb/content/elasticsearch/elasticsearch.html" target="_blank" rel="external">https://taowen.gitbooks.io/tsdb/content/elasticsearch/elasticsearch.html</a><br><a href="http://www.cnblogs.com/forfuture1978/p/3945755.html" target="_blank" rel="external">http://www.cnblogs.com/forfuture1978/p/3945755.html</a><br><a href="https://www.elastic.co/guide/en/elasticsearch/guide/2.x/parent-child.html" target="_blank" rel="external">https://www.elastic.co/guide/en/elasticsearch/guide/2.x/parent-child.html</a></p>

        </div>
        <footer class="article-footer">
            

    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>



        </footer>
    </div>
</article>

    <section id="comments">
    
        
    <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>

    
    </section>


                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/leonlibraries" target="_blank">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
                
                <li>
                    <a class="social-tooltip" title="rss" href="/" target="_blank">
                        <i class="icon fa fa-rss"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
    
        <a href="/2017/04/20/ElasticSearch内部机制浅析二/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">ElasticSearch 内部机制浅析（二）</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/27/ElasticSearch内部机制浅析三/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/27/ElasticSearch内部机制浅析三/segments.jpg)" alt="ElasticSearch 内部机制浅析（三）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/27/ElasticSearch内部机制浅析三/" class="title">ElasticSearch 内部机制浅析（三）</a></p>
                            <p class="item-date"><time datetime="2017-04-27T09:00:15.000Z" itemprop="datePublished">2017-04-27</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/20/ElasticSearch内部机制浅析二/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/20/ElasticSearch内部机制浅析二/cap.jpg)" alt="ElasticSearch 内部机制浅析（二）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/20/ElasticSearch内部机制浅析二/" class="title">ElasticSearch 内部机制浅析（二）</a></p>
                            <p class="item-date"><time datetime="2017-04-20T09:00:15.000Z" itemprop="datePublished">2017-04-20</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/15/ElasticSearch内部机制浅析一/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/15/ElasticSearch内部机制浅析一/framework.jpg)" alt="ElasticSearch 内部机制浅析（一）" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/15/ElasticSearch内部机制浅析一/" class="title">ElasticSearch 内部机制浅析（一）</a></p>
                            <p class="item-date"><time datetime="2017-04-15T04:00:15.000Z" itemprop="datePublished">2017-04-15</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/14/JVM监控工具小记/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/14/JVM监控工具小记/apm.jpeg)" alt="JVM 监控工具小记" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/APM/">APM</a></p>
                            <p class="item-title"><a href="/2017/04/14/JVM监控工具小记/" class="title">JVM 监控工具小记</a></p>
                            <p class="item-date"><time datetime="2017-04-14T04:00:15.000Z" itemprop="datePublished">2017-04-14</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/2017/04/13/初涉HBase/" class="thumbnail">
    
    
        <span style="background-image:url(/2017/04/13/初涉HBase/datastructure1.jpg)" alt="初涉 HBase" class="thumbnail-image"></span>
    
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/大数据/">大数据</a></p>
                            <p class="item-title"><a href="/2017/04/13/初涉HBase/" class="title">初涉 HBase</a></p>
                            <p class="item-date"><time datetime="2017-04-13T07:56:15.000Z" itemprop="datePublished">2017-04-13</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/APM/">APM</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/代码设计/">代码设计</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/全文搜索/">全文搜索</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/前端那些事儿/">前端那些事儿</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/大数据/">大数据</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/当我们在谈论多线程的时候，我们在谈论什么/">当我们在谈论多线程的时候，我们在谈论什么</a><span class="category-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">归档</h3>
        <div class="widget">
            <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">四月 2017</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">三月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">2</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CDH/">CDH</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ECMAScript6/">ECMAScript6</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HBase/">HBase</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lucene/">Lucene</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Relay/">Relay</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/StupidIE/">StupidIE</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/full-text-search/">full-text search</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lucene/">lucene</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web前端/">web前端</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/代码设计/">代码设计</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/全文搜索/">全文搜索</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图片搜索/">图片搜索</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/干货/">干货</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/并发编程/">并发编程</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/架构/">架构</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/模块化/">模块化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/监控/">监控</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/面向对象/">面向对象</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/CDH/" style="font-size: 10px;">CDH</a> <a href="/tags/ECMAScript6/" style="font-size: 15px;">ECMAScript6</a> <a href="/tags/HBase/" style="font-size: 12.5px;">HBase</a> <a href="/tags/Hadoop/" style="font-size: 12.5px;">Hadoop</a> <a href="/tags/JVM/" style="font-size: 15px;">JVM</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Lucene/" style="font-size: 10px;">Lucene</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Relay/" style="font-size: 10px;">Relay</a> <a href="/tags/StupidIE/" style="font-size: 10px;">StupidIE</a> <a href="/tags/full-text-search/" style="font-size: 10px;">full-text search</a> <a href="/tags/lucene/" style="font-size: 10px;">lucene</a> <a href="/tags/web前端/" style="font-size: 17.5px;">web前端</a> <a href="/tags/代码设计/" style="font-size: 10px;">代码设计</a> <a href="/tags/全文搜索/" style="font-size: 15px;">全文搜索</a> <a href="/tags/图片搜索/" style="font-size: 10px;">图片搜索</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/大数据/" style="font-size: 17.5px;">大数据</a> <a href="/tags/干货/" style="font-size: 10px;">干货</a> <a href="/tags/并发编程/" style="font-size: 12.5px;">并发编程</a> <a href="/tags/架构/" style="font-size: 10px;">架构</a> <a href="/tags/模块化/" style="font-size: 10px;">模块化</a> <a href="/tags/监控/" style="font-size: 10px;">监控</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a> <a href="/tags/面向对象/" style="font-size: 10px;">面向对象</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://www.zhihu.com/people/wang-li-ran/activities">知乎</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>
                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2017 雨夜偷牛的人</p>
                <p>Powered by <a href="//hexo.io/" target="_blank">Hexo</a>. Theme by <a href="//github.com/ppoffice" target="_blank">PPOffice</a></p>
            </div>
        </div>
    </div>
</footer>
        
    
    <script>
    var disqus_shortname = 'hexo-theme-hueman';
    
    
    var disqus_url = 'https://leonlibraries.github.io/2017/04/27/ElasticSearch内部机制浅析三/';
    
    (function() {
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
    


<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>
